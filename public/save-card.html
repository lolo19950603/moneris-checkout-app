<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Save Card</title>

  <!-- Moneris Checkout JS -->
  <!-- QA -->
  <script src="https://gateway.moneris.com/chkt/js/chkt_v1.00.js"></script>
  <!-- PROD (switch when ready) -->
  <!-- <script src="https://gateway.moneris.com/chkt/js/chkt_v1.00.js"></script> -->

  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
  </style>
</head>
<body>

<h2>Save your card</h2>
<div id="monerisCheckout"></div>

<script>
  // 1️⃣ Get ticket from URL
  const params = new URLSearchParams(window.location.search);
  const ticket = params.get('ticket');
  const customerId = '67417342117' //params.get('customer_id'); //use a specific customer id for now

  if (!ticket || !customerId) {
    alert('Missing ticket or customer ID');
    throw new Error('Missing required params');
  }

  // 2️⃣ Start Moneris Checkout
  const myCheckout = new monerisCheckout();

  myCheckout.setMode('prod'); // change to 'prod' in production
  myCheckout.setCheckoutDiv('monerisCheckout');

  myCheckout.setCallback('payment_complete', async function (response) {
    // send ticket to backend to get token
    const shopify_customer_save_res = await fetch('/save-card/save-to-shopify-customer', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ ticket })
    });

    const card_data = await shopify_customer_save_res.json();
    alert("card saved: " + card_data.success);
    window.location.href = 'https://dev2diabetesexpress.myshopify.com/account';
  });

  myCheckout.setCallback('error_event', function (err) {
    console.error('Moneris error:', err);
    alert('Moneris error occurred');
  });


  myCheckout.startCheckout(ticket);
</script>

</body>
</html>
